# Node.js自动化与GitHub Actions技术学习笔记

**研究日期**: 2026-02-12  
**研究主题**: Node.js自动化脚本 + GitHub Actions CI/CD

---

## 一、Node.js自动化脚本

### 1.1 核心概念

Node.js是基于Chrome V8引擎的JavaScript运行时，特点是：
- **事件驱动** (Event-Driven)
- **非阻塞I/O** (Non-blocking I/O)
- **单线程** (Single-threaded with Event Loop)

非常适合构建：
- CLI命令行工具
- 自动化脚本
- 网络应用服务端
- 文件系统操作

### 1.2 CLI工具开发实战

#### 常用核心库

```javascript
// 命令行参数解析
const { program } = require('commander');

// 交互式提示
const inquirer = require('inquirer');

// 彩色输出
const chalk = require('chalk');

// 加载动画
const ora = require('ora');

// 文件系统操作
const fs = require('fs-extra');

// 路径处理
const path = require('path');

// HTTP请求
const axios = require('axios');
```

#### CLI工具模板

```javascript
#!/usr/bin/env node
// cli-tool.js

const { program } = require('commander');
const chalk = require('chalk');
const ora = require('ora');

program
  .name('my-cli')
  .description('自动化CLI工具')
  .version('1.0.0');

// 命令1: 初始化项目
program
  .command('init <project-name>')
  .description('初始化新项目')
  .option('-t, --template <type>', '项目模板', 'default')
  .action(async (projectName, options) => {
    const spinner = ora('正在创建项目...').start();
    
    try {
      // 创建项目逻辑
      await createProject(projectName, options.template);
      spinner.succeed(chalk.green(`项目 ${projectName} 创建成功！`));
    } catch (error) {
      spinner.fail(chalk.red('创建失败: ' + error.message));
      process.exit(1);
    }
  });

// 命令2: 批量处理文件
program
  .command('batch <pattern>')
  .description('批量处理文件')
  .action(async (pattern) => {
    console.log(chalk.blue(`正在处理匹配 ${pattern} 的文件...`));
    // 批量处理逻辑
  });

program.parse();
```

### 1.3 自动化脚本场景示例

#### 场景1: 批量文件处理

```javascript
// scripts/batch-rename.js
const fs = require('fs').promises;
const path = require('path');

async function batchRename(dir, pattern, replacement) {
  const files = await fs.readdir(dir);
  
  for (const file of files) {
    if (file.includes(pattern)) {
      const oldPath = path.join(dir, file);
      const newPath = path.join(dir, file.replace(pattern, replacement));
      await fs.rename(oldPath, newPath);
      console.log(`✓ ${file} → ${path.basename(newPath)}`);
    }
  }
}

// 使用
batchRename('./docs', '.md', '.txt');
```

#### 场景2: API数据抓取

```javascript
// scripts/fetch-data.js
const axios = require('axios');
const fs = require('fs-extra');

async function fetchAndSave(url, outputPath) {
  try {
    const { data } = await axios.get(url, {
      headers: {
        'User-Agent': 'Mozilla/5.0 (Automation Script)'
      },
      timeout: 10000
    });
    
    await fs.outputJson(outputPath, data, { spaces: 2 });
    console.log(`✓ 数据已保存至 ${outputPath}`);
    return data;
  } catch (error) {
    console.error(`✗ 抓取失败: ${error.message}`);
    throw error;
  }
}

// 批量抓取
async function batchFetch(urls) {
  const results = await Promise.allSettled(
    urls.map(url => fetchAndSave(url, `./data/${Date.now()}.json`))
  );
  
  const success = results.filter(r => r.status === 'fulfilled').length;
  console.log(`完成: ${success}/${urls.length}`);
}
```

#### 场景3: 项目初始化脚手架

```javascript
// scripts/init-project.js
const fs = require('fs-extra');
const path = require('path');

const templates = {
  'web-app': {
    dirs: ['src', 'public', 'tests'],
    files: {
      'package.json': {
        name: '{{name}}',
        version: '1.0.0',
        scripts: { start: 'node src/index.js' }
      },
      'src/index.js': "console.log('Hello World');",
      '.gitignore': 'node_modules/\ndist/\n.env'
    }
  }
};

async function initProject(name, template) {
  const targetDir = path.join(process.cwd(), name);
  const tpl = templates[template];
  
  if (!tpl) throw new Error(`未知模板: ${template}`);
  
  // 创建目录
  await fs.ensureDir(targetDir);
  for (const dir of tpl.dirs) {
    await fs.ensureDir(path.join(targetDir, dir));
  }
  
  // 创建文件
  for (const [filePath, content] of Object.entries(tpl.files)) {
    const fullPath = path.join(targetDir, filePath);
    await fs.ensureDir(path.dirname(fullPath));
    
    const finalContent = typeof content === 'string' 
      ? content.replace(/\{\{name\}\}/g, name)
      : JSON.stringify(content, null, 2).replace(/\{\{name\}\}/g, name);
    
    await fs.writeFile(fullPath, finalContent);
  }
  
  console.log(`✓ 项目 ${name} 已创建`);
}
```

### 1.4 包管理配置

```json
{
  "name": "my-automation-tools",
  "version": "1.0.0",
  "description": "自动化脚本集合",
  "main": "index.js",
  "bin": {
    "my-cli": "./bin/cli.js"
  },
  "scripts": {
    "start": "node src/index.js",
    "build": "node scripts/build.js",
    "deploy": "node scripts/deploy.js",
    "test": "jest"
  },
  "dependencies": {
    "axios": "^1.6.0",
    "chalk": "^4.1.2",
    "commander": "^11.0.0",
    "fs-extra": "^11.1.0",
    "inquirer": "^9.0.0",
    "ora": "^5.4.1"
  },
  "devDependencies": {
    "jest": "^29.0.0"
  },
  "engines": {
    "node": ">=18.0.0"
  }
}
```

---

## 二、GitHub Actions持续集成

### 2.1 核心概念

**GitHub Actions**是GitHub提供的CI/CD平台：
- **Workflow** (工作流): 自动化流程定义
- **Job** (任务): 工作流中的执行单元
- **Step** (步骤): 任务中的执行步骤
- **Action** (动作): 可复用的代码单元

### 2.2 工作流文件结构

```yaml
# .github/workflows/main.yml
name: CI/CD Pipeline

# 触发条件
on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 0 * * 1'  # 每周一运行
  workflow_dispatch:  # 手动触发

# 环境变量
env:
  NODE_VERSION: '18'
  REGISTRY: ghcr.io

jobs:
  # 任务1: 代码检查与测试
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: 设置Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: 安装依赖
        run: npm ci
      
      - name: 代码检查
        run: npm run lint
      
      - name: 运行测试
        run: npm test
      
      - name: 上传测试报告
        uses: actions/upload-artifact@v4
        with:
          name: test-report
          path: coverage/

  # 任务2: 构建
  build:
    needs: test  # 依赖test任务
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: 安装依赖
        run: npm ci
      
      - name: 构建项目
        run: npm run build
      
      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: dist/

  # 任务3: 部署
  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'  # 仅在main分支
    environment: production
    steps:
      - name: 下载构建产物
        uses: actions/download-artifact@v4
        with:
          name: build-output
          path: dist/
      
      - name: 部署到服务器
        run: |
          echo "部署中..."
          # 部署脚本
```

### 2.3 常用Actions清单

| Action | 用途 |
|--------|------|
| `actions/checkout@v4` | 检出代码 |
| `actions/setup-node@v4` | 设置Node环境 |
| `actions/setup-python@v5` | 设置Python环境 |
| `actions/cache@v3` | 缓存依赖 |
| `actions/upload-artifact@v4` | 上传构建产物 |
| `actions/download-artifact@v4` | 下载构建产物 |
| `actions/github-script@v7` | 执行GitHub API操作 |
| `docker/build-push-action@v5` | 构建和推送Docker镜像 |

### 2.4 实战工作流示例

#### 示例1: Node.js项目CI

```yaml
# .github/workflows/node-ci.yml
name: Node.js CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node-version: [18.x, 20.x]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: 使用Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
      
      - name: 缓存npm依赖
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
      
      - run: npm ci
      - run: npm run build --if-present
      - run: npm test
```

#### 示例2: 自动发布Release

```yaml
# .github/workflows/release.yml
name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
          registry-url: 'https://registry.npmjs.org'
      
      - run: npm ci
      - run: npm run build
      
      - name: 创建Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          draft: false
          prerelease: false
      
      - name: 发布到npm
        run: npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
```

#### 示例3: 定时任务

```yaml
# .github/workflows/scheduled.yml
name: Scheduled Tasks

on:
  schedule:
    - cron: '0 9 * * *'  # 每天上午9点

jobs:
  daily-report:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - run: npm ci
      
      - name: 生成日报
        run: node scripts/daily-report.js
        env:
          API_KEY: ${{ secrets.API_KEY }}
      
      - name: 发送邮件
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: 每日数据报告
          to: team@example.com
          from: bot@example.com
          attachments: report.pdf
```

### 2.5 Secrets管理

```bash
# 设置Secrets (命令行)
gh secret set API_KEY --body "your-api-key"
gh secret set DEPLOY_KEY --bodyFile deploy_key.pem
```

```yaml
# 在Workflow中使用
jobs:
  deploy:
    steps:
      - name: 部署
        run: |
          echo "使用API_KEY: ${{ secrets.API_KEY }}"
          deploy --key ${{ secrets.DEPLOY_KEY }}
```

---

## 三、餐饮项目技术方案

### 3.1 项目架构设计

```
restaurant-ai-saas/
├── .github/
│   └── workflows/
│       ├── ci.yml           # 持续集成
│       ├── deploy.yml       # 自动部署
│       └── schedule.yml     # 定时任务
├── scripts/
│   ├── init-project.js      # 项目初始化
│   ├── build-cli.js         # CLI构建
│   └── deploy.js            # 部署脚本
├── src/
│   ├── api/                 # API接口
│   ├── cli/                 # 命令行工具
│   ├── core/                # 核心业务逻辑
│   └── utils/               # 工具函数
├── tests/
├── package.json
└── README.md
```

### 3.2 推荐技术栈

| 层级 | 技术选型 |
|------|----------|
| **运行时** | Node.js 18+ |
| **框架** | Express.js / Fastify |
| **数据库** | PostgreSQL + Redis |
| **ORM** | Prisma |
| **CLI** | Commander.js |
| **测试** | Jest + Supertest |
| **CI/CD** | GitHub Actions |
| **部署** | Docker + VPS |

### 3.3 核心模块设计

```javascript
// src/core/voice-agent.js
class VoiceAgent {
  constructor(config) {
    this.asr = new ASRService(config.asr);
    this.nlu = new NLUService(config.nlu);
    this.tts = new TTSService(config.tts);
  }
  
  async process(audioStream) {
    // 1. 语音识别
    const text = await this.asr.recognize(audioStream);
    
    // 2. 意图理解
    const intent = await this.nlu.parse(text);
    
    // 3. 业务处理
    const response = await this.handleIntent(intent);
    
    // 4. 语音合成
    return await this.tts.synthesize(response);
  }
}

// src/cli/index.js
program
  .command('serve')
  .description('启动语音服务')
  .option('-p, --port <port>', '端口号', '3000')
  .action(async (options) => {
    const server = new VoiceServer({
      port: parseInt(options.port)
    });
    await server.start();
    console.log(chalk.green(`✓ 服务已启动，端口: ${options.port}`));
  });
```

---

## 四、学习资源

### 4.1 Node.js学习
- [Node.js官方文档](https://nodejs.org/docs/latest/api/)
- [Node.js CLI Apps最佳实践](https://github.com/lirantal/nodejs-cli-apps-best-practices)
- 《Node.js实战(第2版)》

### 4.2 GitHub Actions学习
- [GitHub Actions官方文档](https://docs.github.com/en/actions)
- [Workflow语法参考](https://docs.github.com/en/actions/reference/workflow-syntax)
- [GitHub Actions CI/CD实战](https://www.cnblogs.com/jonil/p/17666389.html)

### 4.3 推荐练习
1. 用Node.js写一个文件批量处理脚本
2. 创建一个命令行工具，支持交互式提示
3. 为现有项目添加GitHub Actions CI配置
4. 实现自动化部署流程

---

*学习完成时间: 2026-02-12*
