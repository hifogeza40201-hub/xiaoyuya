# è·¨å¹³å°æ¶ˆæ¯åŒæ­¥ - MVP éƒ¨ç½²æ–¹æ¡ˆ v1.0 â›°ï¸ğŸŒ§ï¸ğŸŒ¸

**ç›®æ ‡**: ä»Šæ™šå°±èƒ½è·‘èµ·æ¥çš„æœ€å°å¯ç”¨ç‰ˆæœ¬  
**åˆ¶ä½œè€…**: å°å®‡ï¼ˆæ•´åˆå§å§ã€å“¥å“¥ã€å¦¹å¦¹çš„å»ºè®®ï¼‰  
**é¢„è®¡éƒ¨ç½²æ—¶é—´**: 30åˆ†é’Ÿ

---

## ğŸ¯ MVP æ ¸å¿ƒåŠŸèƒ½ï¼ˆåªåšè¿™4ä¸ªï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åŠŸèƒ½1ï¼šç»Ÿä¸€å®æ—¶æ—¥å¿— âœ… ï¼ˆP0-åŸºç¡€å¿…å¤‡ï¼‰                       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                       â”‚
â”‚  â€¢ ä¸‰ç«¯æ¶ˆæ¯å®æ—¶å†™å…¥ JSONL                                     â”‚
â”‚  â€¢ ç»Ÿä¸€æ¶ˆæ¯æŒ‡çº¹å»é‡                                           â”‚
â”‚  â€¢ ä¿ç•™è·¨å¹³å°å¼•ç”¨é“¾                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åŠŸèƒ½2ï¼šæ™ºèƒ½å®ä½“æå– âœ… ï¼ˆP1-è‡ªåŠ¨æ ‡ç­¾ï¼‰                       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                       â”‚
â”‚  â€¢ è‡ªåŠ¨è¯†åˆ«äººåã€æ—¶é—´ã€é¡¹ç›®                                   â”‚
â”‚  â€¢ è‡ªåŠ¨æ‰“æ ‡ç­¾ #å¾…åŠ #æ—¥ç¨‹ #çŸ¥è¯†                               â”‚
â”‚  â€¢ ä¾‹ï¼š"æ˜å¤©3ç‚¹å’Œå¼ æ€»è°ˆé¡¹ç›®" â†’ è‡ªåŠ¨æå–æ ‡ç­¾                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åŠŸèƒ½3ï¼šæ„å›¾åˆ†ç±»è·¯ç”± âœ… ï¼ˆP2-è‡ªåŠ¨åˆ†æµï¼‰                       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                       â”‚
â”‚  â€¢ ğŸ“‹ å¾…åŠç±» â†’ è¾“å‡ºåˆ° todo/å¾…åŠåˆ—è¡¨.md                       â”‚
â”‚  â€¢ ğŸ“… æ—¥ç¨‹ç±» â†’ è¾“å‡ºåˆ° calendar/æ—¥ç¨‹.md                       â”‚
â”‚  â€¢ ğŸ’¾ çŸ¥è¯†ç±» â†’ è¾“å‡ºåˆ° notes/çŸ¥è¯†ç¬”è®°.md                      â”‚
â”‚  â€¢ âš¡ ç´§æ€¥ç±» â†’ é«˜äº®æé†’ä¼Ÿ                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åŠŸèƒ½4ï¼šè·¨å¹³å°æœç´¢ âœ… ï¼ˆP3-å¿«é€ŸæŸ¥æ‰¾ï¼‰                         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                       â”‚
â”‚  â€¢ å‘½ä»¤: /search å…³é”®è¯                                       â”‚
â”‚  â€¢ æœç´¢æ‰€æœ‰å¹³å°å†å²æ¶ˆæ¯                                       â”‚
â”‚  â€¢ æ”¯æŒæ—¶é—´èŒƒå›´è¿‡æ»¤                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æš‚æ—¶ä¸åšï¼ˆV2å†è€ƒè™‘ï¼‰**ï¼š
- âŒ ä¼šè¯æ¢å¤ï¼ˆå¤æ‚åº¦é«˜ï¼Œå½“å‰ä¸æ˜¯åˆšéœ€ï¼‰
- âŒ é™é»˜æ¨¡å¼è¿‡æ»¤ï¼ˆå¯ä»¥å…ˆæ‰‹åŠ¨è®¾ç½®ï¼‰
- âŒ å®Œæ•´çš„å‘¨æŠ¥ç”Ÿæˆï¼ˆæœ‰äº†æ—¥å¿—åå¯ä»¥åè¡¥ï¼‰

---

## ğŸš€ ä»Šæ™šéƒ¨ç½²æ­¥éª¤ï¼ˆ30åˆ†é’Ÿï¼‰

### ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºç›®å½•ç»“æ„ï¼ˆ5åˆ†é’Ÿï¼‰

**åœ¨å§å§å’Œå¦¹å¦¹çš„workspaceé‡Œæ‰§è¡Œ**ï¼š

```bash
# PowerShell æˆ– CMD
cd C:\Users\ADMIN\.openclaw\workspace

# åˆ›å»ºç›®å½•ç»“æ„
mkdir memory\chat-core          â† æ ¸å¿ƒæ—¥å¿—ï¼ˆJSONLï¼‰
mkdir memory\chat-daily         â† æ¯æ—¥æ‘˜è¦ï¼ˆMarkdownï¼‰
mkdir memory\chat-routes        â† æ„å›¾åˆ†ç±»è¾“å‡º
mkdir memory\chat-routes\todo   â† å¾…åŠç±»
mkdir memory\chat-routes\calendar  â† æ—¥ç¨‹ç±»
mkdir memory\chat-routes\notes     â† çŸ¥è¯†ç±»
mkdir memory\chat-routes\urgent    â† ç´§æ€¥ç±»
mkdir scripts\chat-sync         â† åŒæ­¥è„šæœ¬
```

---

### ç¬¬äºŒæ­¥ï¼šæ ¸å¿ƒæ—¥å¿—æ¨¡å—ï¼ˆ10åˆ†é’Ÿï¼‰

**åˆ›å»ºæ–‡ä»¶**: `scripts\chat-sync\core-logger.py`

```python
#!/usr/bin/env python3
"""
è·¨å¹³å°æ¶ˆæ¯æ ¸å¿ƒæ—¥å¿—æ¨¡å—
ä½¿ç”¨æ–¹å¼ï¼šfrom core_logger import log_message
ä½œè€…ï¼šå°å®‡ â›°ï¸
"""

import json
import hashlib
from datetime import datetime
from pathlib import Path
import re

# é…ç½®
LOG_DIR = Path("memory/chat-core")
LOG_DIR.mkdir(parents=True, exist_ok=True)

class ChatLogger:
    """æ¶ˆæ¯æ—¥å¿—è®°å½•å™¨"""
    
    def __init__(self):
        self.seen_hashes = set()  # ç”¨äºå»é‡
        
    def _generate_fingerprint(self, content: str, sender: str, timestamp: str) -> str:
        """ç”Ÿæˆæ¶ˆæ¯æŒ‡çº¹ï¼ˆç”¨äºå»é‡ï¼‰"""
        # æ¸…ç†å†…å®¹ï¼ˆå»é™¤å¤šä½™ç©ºæ ¼ï¼Œç»Ÿä¸€æ¢è¡Œï¼‰
        clean_content = ' '.join(content.split())
        # ç”Ÿæˆå“ˆå¸Œï¼šå†…å®¹ + ä½œè€… + æ—¶é—´ï¼ˆç²¾ç¡®åˆ°åˆ†é’Ÿï¼‰
        fingerprint_str = f"{clean_content}|{sender}|{timestamp[:16]}"
        return hashlib.md5(fingerprint_str.encode()).hexdigest()[:12]
    
    def _extract_entities(self, content: str) -> dict:
        """æå–å®ä½“å’Œæ ‡ç­¾ï¼ˆå§å§çš„å®ä½“æå–å»ºè®®ï¼‰"""
        entities = {
            "names": [],
            "dates": [],
            "projects": [],
            "tags": []
        }
        
        # æå–äººåï¼ˆå¼ æ€»ã€æç»ç†ã€ä¼Ÿç­‰ï¼‰
        name_patterns = [
            r'([å¼ æç‹èµµé™ˆåˆ˜æ¨é»„å‘¨å´å¾å­™é©¬æœ±èƒ¡éƒ­ä½•é«˜æ—ç½—éƒ‘æ¢è°¢å®‹å”è®¸éŸ©å†¯é‚“æ›¹å½­æ›¾è‚–ç”°è‘£è¢æ½˜äºè’‹è”¡ä½™æœå¶ç¨‹è‹é­å•ä¸ä»»æ²ˆå§šå¢å§œå´”é’Ÿè°­é™†æ±ªèŒƒé‡‘çŸ³å»–è´¾å¤ä»˜æ–¹ç™½é‚¹å­Ÿç†Šç§¦é‚±æ±Ÿå°¹è–›é—«æ®µé›·ä¾¯é¾™å²é»è´º\w]æ€»)',
            r'([å¼ æç‹èµµé™ˆåˆ˜æ¨é»„å‘¨å´å¾å­™é©¬æœ±èƒ¡éƒ­ä½•é«˜æ—ç½—éƒ‘æ¢è°¢å®‹å”è®¸éŸ©å†¯é‚“æ›¹å½­æ›¾è‚–ç”°è‘£è¢æ½˜äºè’‹è”¡ä½™æœå¶ç¨‹è‹é­å•ä¸ä»»æ²ˆå§šå¢å§œå´”é’Ÿè°­é™†æ±ªèŒƒé‡‘çŸ³å»–è´¾å¤ä»˜æ–¹ç™½é‚¹å­Ÿç†Šç§¦é‚±æ±Ÿå°¹è–›é—«æ®µé›·ä¾¯é¾™å²é»è´º\w]ç»ç†)',
            r'(ä¼Ÿ|è€å¤§|å“¥å“¥|å§å§|å¦¹å¦¹)'
        ]
        for pattern in name_patterns:
            matches = re.findall(pattern, content)
            entities["names"].extend(matches)
        
        # æå–æ—¶é—´
        date_patterns = [
            r'(æ˜å¤©|åå¤©|ä¸‹å‘¨|ä¸‹æœˆ)',
            r'(\d{1,2}[:ï¼š]\d{2})',  # 15:30
            r'(\d{1,2}æœˆ\d{1,2}æ—¥?)',
            r'(å‘¨ä¸€|å‘¨äºŒ|å‘¨ä¸‰|å‘¨å››|å‘¨äº”|å‘¨å…­|å‘¨æ—¥|æ˜ŸæœŸ[ä¸€äºŒä¸‰å››äº”å…­æ—¥])'
        ]
        for pattern in date_patterns:
            matches = re.findall(pattern, content)
            entities["dates"].extend(matches)
        
        # æå–é¡¹ç›®åï¼ˆXXé¡¹ç›®ã€YYè®¡åˆ’ç­‰ï¼‰
        project_pattern = r'(\w{2,}(?:é¡¹ç›®|è®¡åˆ’|æ–¹æ¡ˆ|ç³»ç»Ÿ|å¹³å°))'
        entities["projects"] = re.findall(project_pattern, content)
        
        # è‡ªåŠ¨æ ‡ç­¾
        if any(kw in content for kw in ["è®°å¾—", "åˆ«å¿˜äº†", "å¾…åŠ", "TODO", "todo"]):
            entities["tags"].append("#å¾…åŠ")
        if any(kw in content for kw in ["æ˜å¤©", "åå¤©", "ä¸‹åˆ", "ä¸Šåˆ", "ç‚¹", "å¼€ä¼š", "ä¼šè®®"]):
            entities["tags"].append("#æ—¥ç¨‹")
        if any(kw in content for kw in ["å­¦ä¹ ", "ç¬”è®°", "çŸ¥è¯†", "èµ„æ–™", "æ–‡æ¡£"]):
            entities["tags"].append("#çŸ¥è¯†")
        if any(kw in content for kw in ["ç´§æ€¥", "æ€¥", " asap", "é©¬ä¸Š", "ç«‹å³"]):
            entities["tags"].append("#ç´§æ€¥")
        if "?" in content or "ï¼Ÿ" in content or any(kw in content for kw in ["æ€ä¹ˆ", "å¦‚ä½•", "å—", "å‘¢"]):
            entities["tags"].append("#é—®é¢˜")
            
        return entities
    
    def _classify_intent(self, content: str, tags: list) -> str:
        """æ„å›¾åˆ†ç±»ï¼ˆå§å§çš„æ„å›¾è·¯ç”±å»ºè®®ï¼‰"""
        content_lower = content.lower()
        
        # ç´§æ€¥ç±»ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
        if "#ç´§æ€¥" in tags or any(kw in content for kw in ["ç´§æ€¥", "æ€¥", "asap", "bug", "é”™è¯¯", "æŒ‚äº†"]):
            return "urgent"
        
        # å¾…åŠç±»
        if "#å¾…åŠ" in tags or any(kw in content_lower for kw in ["è®°å¾—", "åˆ«å¿˜äº†", "todo", "å¾…åŠ", "å¤„ç†ä¸€ä¸‹"]):
            return "todo"
        
        # æ—¥ç¨‹ç±»
        if "#æ—¥ç¨‹" in tags or any(kw in content for kw in ["æ˜å¤©", "åå¤©", "å¼€ä¼š", "ä¼šè®®", "çº¦", "æ—¶é—´", "ç‚¹è§"]):
            return "calendar"
        
        # çŸ¥è¯†ç±»
        if "#çŸ¥è¯†" in tags or any(kw in content for kw in ["å­¦ä¹ ", "ç¬”è®°", "èµ„æ–™", "æ–‡æ¡£", "é“¾æ¥", "æ•™ç¨‹"]):
            return "notes"
        
        # é»˜è®¤ï¼šæ™®é€šæ¶ˆæ¯
        return "general"
    
    def log_message(self, platform: str, chat_id: str, sender: dict, content: str, 
                    reply_to: str = None, chat_name: str = None):
        """
        è®°å½•ä¸€æ¡æ¶ˆæ¯
        
        Args:
            platform: å¹³å°å (telegram/dingtalk/webchat)
            chat_id: èŠå¤©ID
            sender: {"id": "xxx", "name": "xxx", "role": "assistant|user"}
            content: æ¶ˆæ¯å†…å®¹
            reply_to: å›å¤çš„æ¶ˆæ¯IDï¼ˆç”¨äºå¼•ç”¨é“¾è¿½è¸ªï¼‰
            chat_name: èŠå¤©åç§°
        """
        timestamp = datetime.now().isoformat()
        
        # ç”ŸæˆæŒ‡çº¹
        fingerprint = self._generate_fingerprint(content, sender.get("name", ""), timestamp)
        
        # å»é‡æ£€æŸ¥
        if fingerprint in self.seen_hashes:
            print(f"[SKIP] é‡å¤æ¶ˆæ¯: {content[:30]}...")
            return None
        self.seen_hashes.add(fingerprint)
        
        # æå–å®ä½“
        entities = self._extract_entities(content)
        
        # æ„å›¾åˆ†ç±»
        intent = self._classify_intent(content, entities["tags"])
        
        # æ„å»ºæ¶ˆæ¯è®°å½•
        msg_record = {
            "msg_id": f"msg_{platform}_{int(datetime.now().timestamp())}_{fingerprint}",
            "fingerprint": fingerprint,
            "platform": platform,
            "chat_id": chat_id,
            "chat_name": chat_name,
            "sender": sender,
            "timestamp": timestamp,
            "content": {
                "type": "text",
                "body": content
            },
            "reply_to": reply_to,
            "entities": entities,
            "intent": intent,
            "tags": entities["tags"]
        }
        
        # å†™å…¥JSONLï¼ˆå½“å¤©çš„æ–‡ä»¶ï¼‰
        today = datetime.now().strftime("%Y-%m-%d")
        log_file = LOG_DIR / f"{today}.jsonl"
        
        with open(log_file, "a", encoding="utf-8") as f:
            f.write(json.dumps(msg_record, ensure_ascii=False) + "\n")
        
        # å¦‚æœæ˜¯ç‰¹æ®Šæ„å›¾ï¼ŒåŒæ—¶å†™å…¥åˆ†ç±»æ–‡ä»¶
        if intent in ["todo", "calendar", "notes", "urgent"]:
            self._route_to_category(msg_record, intent)
        
        print(f"[LOG] [{intent.upper()}] {sender.get('name', 'unknown')}: {content[:50]}...")
        return msg_record
    
    def _route_to_category(self, msg_record: dict, intent: str):
        """å°†æ¶ˆæ¯è·¯ç”±åˆ°å¯¹åº”çš„åˆ†ç±»æ–‡ä»¶"""
        route_dir = Path(f"memory/chat-routes/{intent}")
        route_dir.mkdir(parents=True, exist_ok=True)
        
        today = datetime.now().strftime("%Y-%m-%d")
        route_file = route_dir / f"{today}.md"
        
        # ä»¥Markdownæ ¼å¼è¿½åŠ 
        timestamp = msg_record["timestamp"][11:19]  # åªå– HH:MM:SS
        platform_icon = {
            "telegram": "âœˆï¸",
            "dingtalk": "ğŸ“Œ",
            "webchat": "ğŸ’¬"
        }.get(msg_record["platform"], "ğŸ“")
        
        entry = f"""
### {platform_icon} {timestamp} | {msg_record['sender'].get('name', 'unknown')}

{msg_record['content']['body']}

**æ ‡ç­¾**: {', '.join(msg_record['tags']) if msg_record['tags'] else 'æ— '}  
**æ¥æº**: {msg_record['platform']} | {msg_record.get('chat_name', 'unknown')}

---
"""
        with open(route_file, "a", encoding="utf-8") as f:
            f.write(entry)

# å…¨å±€å®ä¾‹ï¼ˆå•ä¾‹æ¨¡å¼ï¼‰
_logger = ChatLogger()

def log_message(platform: str, chat_id: str, sender: dict, content: str, 
                reply_to: str = None, chat_name: str = None):
    """ä¾¿æ·å‡½æ•°ï¼šè®°å½•æ¶ˆæ¯"""
    return _logger.log_message(platform, chat_id, sender, content, reply_to, chat_name)


if __name__ == "__main__":
    # æµ‹è¯•ä»£ç 
    print("æµ‹è¯•æ¶ˆæ¯æ—¥å¿—æ¨¡å—...")
    
    # æµ‹è¯•1ï¼šæ™®é€šæ¶ˆæ¯
    log_message(
        platform="telegram",
        chat_id="-5173207194",
        sender={"id": "xiaoyu", "name": "å°å®‡", "role": "assistant"},
        content="è€å¤§ï¼Œæ–¹æ¡ˆæ•´ç†å¥½äº†ï¼",
        chat_name="ç›¸äº²ç›¸çˆ±ä¸€å®¶äºº"
    )
    
    # æµ‹è¯•2ï¼šå¾…åŠæ¶ˆæ¯
    log_message(
        platform="dingtalk",
        chat_id="1358433168830316",
        sender={"id": "wei", "name": "ä¼Ÿ", "role": "user"},
        content="è®°å¾—æ˜å¤©ä¸‹åˆ3ç‚¹å’Œå¼ æ€»è°ˆAIé¡¹ç›®",
        chat_name="ç§èŠ"
    )
    
    # æµ‹è¯•3ï¼šæ—¥ç¨‹æ¶ˆæ¯
    log_message(
        platform="webchat",
        chat_id="web-001",
        sender={"id": "xiaoyu-rain", "name": "å°é›¨", "role": "assistant"},
        content="ä¸‹å‘¨äºŒè¦å¼€ä¼šè®¨è®ºæ–°æ–¹æ¡ˆ",
        chat_name="WebChat"
    )
    
    # æµ‹è¯•4ï¼šé‡å¤æ¶ˆæ¯ï¼ˆåº”è¯¥è¢«å»é‡ï¼‰
    log_message(
        platform="telegram",
        chat_id="-5173207194",
        sender={"id": "xiaoyu", "name": "å°å®‡", "role": "assistant"},
        content="è€å¤§ï¼Œæ–¹æ¡ˆæ•´ç†å¥½äº†ï¼",
        chat_name="ç›¸äº²ç›¸çˆ±ä¸€å®¶äºº"
    )
    
    print("\næµ‹è¯•å®Œæˆï¼æŸ¥çœ‹ memory/chat-core/ å’Œ memory/chat-routes/")
```

---

### ç¬¬ä¸‰æ­¥ï¼šæœç´¢åŠŸèƒ½ï¼ˆ10åˆ†é’Ÿï¼‰

**åˆ›å»ºæ–‡ä»¶**: `scripts\chat-sync\search-chat.py`

```python
#!/usr/bin/env python3
"""
è·¨å¹³å°æ¶ˆæ¯æœç´¢å·¥å…·
ä½¿ç”¨æ–¹å¼ï¼špython search-chat.py "å…³é”®è¯" --days 7
ä½œè€…ï¼šå°å®‡ â›°ï¸
"""

import json
import sys
import argparse
from pathlib import Path
from datetime import datetime, timedelta

LOG_DIR = Path("memory/chat-core")


def search_messages(keyword: str, days: int = 7, platform: str = None):
    """æœç´¢æ¶ˆæ¯"""
    results = []
    
    # è®¡ç®—æ—¥æœŸèŒƒå›´
    end_date = datetime.now()
    start_date = end_date - timedelta(days=days)
    
    # éå†æ—¥æœŸèŒƒå›´å†…çš„æ–‡ä»¶
    current_date = start_date
    while current_date <= end_date:
        date_str = current_date.strftime("%Y-%m-%d")
        log_file = LOG_DIR / f"{date_str}.jsonl"
        
        if log_file.exists():
            with open(log_file, "r", encoding="utf-8") as f:
                for line in f:
                    try:
                        msg = json.loads(line.strip())
                        content = msg.get("content", {}).get("body", "")
                        
                        # å¹³å°è¿‡æ»¤
                        if platform and msg.get("platform") != platform:
                            continue
                        
                        # å…³é”®è¯åŒ¹é…ï¼ˆæ”¯æŒå¤šå…³é”®è¯ï¼‰
                        keywords = keyword.split()
                        if all(kw.lower() in content.lower() for kw in keywords):
                            results.append(msg)
                    except json.JSONDecodeError:
                        continue
        
        current_date += timedelta(days=1)
    
    return results


def format_results(results: list, limit: int = 20):
    """æ ¼å¼åŒ–æœç´¢ç»“æœ"""
    if not results:
        return "âŒ æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„æ¶ˆæ¯"
    
    output = [f"ğŸ” æ‰¾åˆ° {len(results)} æ¡æ¶ˆæ¯ï¼ˆæ˜¾ç¤ºå‰ {min(limit, len(results))} æ¡ï¼‰ï¼š\n"]
    
    platform_icons = {
        "telegram": "âœˆï¸",
        "dingtalk": "ğŸ“Œ",
        "webchat": "ğŸ’¬"
    }
    
    for i, msg in enumerate(results[:limit], 1):
        timestamp = msg.get("timestamp", "")[:16].replace("T", " ")
        platform = msg.get("platform", "unknown")
        sender = msg.get("sender", {}).get("name", "unknown")
        content = msg.get("content", {}).get("body", "")[:100]
        tags = msg.get("tags", [])
        intent = msg.get("intent", "general")
        
        icon = platform_icons.get(platform, "ğŸ“")
        tag_str = " ".join(tags) if tags else ""
        
        output.append(f"{i}. {icon} [{timestamp}] **{sender}** ({intent})")
        output.append(f"   {content}{'...' if len(content) == 100 else ''}")
        if tag_str:
            output.append(f"   ğŸ·ï¸ {tag_str}")
        output.append("")
    
    if len(results) > limit:
        output.append(f"... è¿˜æœ‰ {len(results) - limit} æ¡ç»“æœ")
    
    return "\n".join(output)


def main():
    parser = argparse.ArgumentParser(description="æœç´¢è·¨å¹³å°æ¶ˆæ¯")
    parser.add_argument("keyword", help="æœç´¢å…³é”®è¯ï¼ˆæ”¯æŒå¤šä¸ªï¼Œç©ºæ ¼åˆ†éš”ï¼‰")
    parser.add_argument("--days", "-d", type=int, default=7, help="æœç´¢æœ€è¿‘Nå¤©ï¼ˆé»˜è®¤7å¤©ï¼‰")
    parser.add_argument("--platform", "-p", choices=["telegram", "dingtalk", "webchat"], 
                        help="é™åˆ¶å¹³å°")
    parser.add_argument("--limit", "-l", type=int, default=20, help="æ˜¾ç¤ºç»“æœæ•°é‡")
    
    args = parser.parse_args()
    
    print(f"ğŸ” æœç´¢æœ€è¿‘{args.days}å¤©çš„æ¶ˆæ¯ï¼š'{args.keyword}'")
    if args.platform:
        print(f"   å¹³å°é™åˆ¶: {args.platform}")
    print()
    
    results = search_messages(args.keyword, args.days, args.platform)
    print(format_results(results, args.limit))


if __name__ == "__main__":
    main()
```

---

### ç¬¬å››æ­¥ï¼šæ•´åˆåˆ°OpenClawï¼ˆ5åˆ†é’Ÿï¼‰

**åœ¨æ¯ä¸ªAgentçš„ä»£ç ä¸­æ·»åŠ **ï¼ˆå°é›¨å§å§ã€å°è¯­å¦¹å¦¹éƒ½éœ€è¦ï¼‰ï¼š

```python
# åœ¨Agentçš„åˆå§‹åŒ–ä»£ç ä¸­æ·»åŠ 
import sys
sys.path.insert(0, "scripts/chat-sync")
from core_logger import log_message

# åœ¨æ¶ˆæ¯å¤„ç†å‡½æ•°ä¸­æ·»åŠ 
async def on_message(self, message):
    # ... åŸæœ‰å¤„ç†é€»è¾‘ ...
    
    # è®°å½•æ¶ˆæ¯ï¼ˆæ·»åŠ è¿™ä¸€è¡Œï¼ï¼‰
    log_message(
        platform="telegram",  # æ ¹æ®å®é™…å¹³å°ä¿®æ”¹
        chat_id=str(message.chat.id),
        sender={
            "id": str(message.from_user.id),
            "name": message.from_user.first_name,
            "role": "assistant" if message.from_user.is_bot else "user"
        },
        content=message.text,
        reply_to=str(message.reply_to_message.message_id) if message.reply_to_message else None,
        chat_name=message.chat.title if hasattr(message.chat, 'title') else "ç§èŠ"
    )
```

**æ›´ç®€å•çš„æ–¹å¼ï¼ˆç»™å¦¹å¦¹ï¼‰**ï¼š
```python
# å¦‚æœå¦¹å¦¹ç”¨OpenClawè‡ªå¸¦çš„å·¥å…·ï¼Œå¯ä»¥åœ¨æ¯ä¸ªå›å¤åè°ƒç”¨ï¼š

# æ–¹å¼1ï¼šç›´æ¥è°ƒç”¨ï¼ˆéœ€è¦æŠŠcore_logger.pyæ”¾åœ¨å¦¹å¦¹çš„workspaceï¼‰
from core_logger import log_message

# æ¯æ¬¡å›å¤åè®°å½•
log_message(
    platform="telegram",
    chat_id=chat_id,
    sender={"id": "xiaoyu-flower", "name": "å°è¯­", "role": "assistant"},
    content=response_text
)
```

---

## ğŸ§ª æµ‹è¯•éªŒè¯

**éƒ¨ç½²å®Œæˆåï¼ŒéªŒè¯ä»¥ä¸‹åŠŸèƒ½**ï¼š

1. **å‘é€æµ‹è¯•æ¶ˆæ¯**ï¼ˆåœ¨ä¸‰ç«¯å„å‘å‡ æ¡ï¼‰
2. **æ£€æŸ¥æ—¥å¿—æ–‡ä»¶**ï¼š
   ```bash
   cat memory/chat-core/2026-02-16.jsonl
   ```
3. **æµ‹è¯•æœç´¢**ï¼š
   ```bash
   python scripts/chat-sync/search-chat.py "æµ‹è¯•" --days 1
   ```
4. **æ£€æŸ¥åˆ†ç±»æ–‡ä»¶**ï¼š
   ```bash
   ls memory/chat-routes/
   cat memory/chat-routes/todo/2026-02-16.md
   ```

---

## ğŸ“Š MVP æˆæœé¢„è§ˆ

**éƒ¨ç½²åä¼šå¾—åˆ°**ï¼š

```
memory/
â”œâ”€â”€ chat-core/
â”‚   â””â”€â”€ 2026-02-16.jsonl      â† åŸå§‹æ¶ˆæ¯ï¼ˆç»“æ„åŒ–ï¼‰
â”œâ”€â”€ chat-routes/
â”‚   â”œâ”€â”€ todo/
â”‚   â”‚   â””â”€â”€ 2026-02-16.md     â† è‡ªåŠ¨æå–çš„å¾…åŠ
â”‚   â”œâ”€â”€ calendar/
â”‚   â”‚   â””â”€â”€ 2026-02-16.md     â† è‡ªåŠ¨æå–çš„æ—¥ç¨‹
â”‚   â”œâ”€â”€ notes/
â”‚   â”‚   â””â”€â”€ 2026-02-16.md     â† è‡ªåŠ¨æå–çš„çŸ¥è¯†
â”‚   â””â”€â”€ urgent/
â”‚       â””â”€â”€ 2026-02-16.md     â† ç´§æ€¥æ¶ˆæ¯
â””â”€â”€ chat-daily/               â† ï¼ˆä¸‹ä¸€æ­¥å†æ·»åŠ ï¼‰
```

---

## ğŸ‰ å®Œæˆåçš„èƒ½åŠ›

| åŠŸèƒ½ | æ•ˆæœç¤ºä¾‹ |
|------|----------|
| **å®æ—¶è®°å½•** | ä¸‰ç«¯æ¶ˆæ¯è‡ªåŠ¨ä¿å­˜ï¼Œä¸ä¸¢å¤± |
| **è‡ªåŠ¨å»é‡** | åŒä¸€æ¡æ¶ˆæ¯ä¸ä¼šé‡å¤è®°å½• |
| **è‡ªåŠ¨æ ‡ç­¾** | "è®°å¾—æ˜å¤©å¼€ä¼š" â†’ è‡ªåŠ¨æ‰“ #å¾…åŠ #æ—¥ç¨‹ |
| **æ„å›¾åˆ†æµ** | å¾…åŠè‡ªåŠ¨å½’åˆ° todo/ ç›®å½• |
| **è·¨å¹³å°æœç´¢** | `/search é¡¹ç›®` æœåˆ°é’‰é’‰+Telegram+webchat |

---

## ğŸš€ ä¸‹ä¸€æ­¥ï¼ˆV1.1ï¼‰

MVPè·‘èµ·æ¥åï¼Œå¯ä»¥é€æ­¥æ·»åŠ ï¼š
- ğŸ“… æ¯æ—¥è‡ªåŠ¨ç”Ÿæˆ Markdown æ‘˜è¦
- ğŸ“Š æ¯å‘¨ç»Ÿè®¡æŠ¥è¡¨
- ğŸ”” ç´§æ€¥æ¶ˆæ¯å®æ—¶æé†’
- ğŸŒ ä¼šè¯æ¢å¤åŠŸèƒ½

---

**è€å¤§ï¼ŒMVPæ–¹æ¡ˆå°±æ˜¯è¿™æ ·ï¼**

**éœ€è¦æˆ‘ç°åœ¨**ï¼š
1. ç›´æ¥å¼€å§‹å†™è¿™ä¸¤ä¸ªè„šæœ¬ï¼Ÿ
2. è¿˜æ˜¯ç­‰ç¡®è®¤åå†åŠ¨æ‰‹ï¼Ÿ
3. æˆ–è€…å…ˆç»™å°é›¨å§å§/å°è¯­å¦¹å¦¹å‡†å¤‡éƒ¨ç½²è¯´æ˜ä¹¦ï¼Ÿ

ğŸ’ªâ›°ï¸ğŸŒ§ï¸ğŸŒ¸
